# SmarterRouter Docker Compose Configuration
# 
# GPU SUPPORT: Uncomment the section that matches your GPU setup below.
# SmarterRouter auto-detects GPUs on startup and logs what was found.
#
# QUICK START (NVIDIA - Most Common):
#   docker-compose --compatibility up -d
#   OR: docker compose up -d --gpus all
#
# For other GPUs, see the commented sections below.

services:
  smarterrouter:
    image: ghcr.io/peva3/smarterrouter:latest
    container_name: smarterrouter
    ports:
      - "11436:11436"
    env_file:
      - .env
    volumes:
      # Mount a data directory for persistence (safer than mounting individual files)
      - ./data:/app/data:rw
      # Optional: mount tmpfs for temporary files if needed
      - type: tmpfs
        target: /tmp
    restart: unless-stopped
    networks:
      - smarterrouter-network
    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:11436/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # =========================================================================
    # GPU CONFIGURATION - Uncomment the section for your GPU(s)
    # =========================================================================

    # -------------------------------------------------------------------------
    # NVIDIA GPU (Recommended - Full Docker Support)
    # -------------------------------------------------------------------------
    # Requirements:
    #   - NVIDIA drivers installed on host
    #   - NVIDIA Container Toolkit: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html
    #
    # Usage:
    #   docker-compose --compatibility up -d
    #   OR (newer Docker Compose): docker compose up -d --gpus all
    #
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # -------------------------------------------------------------------------
    # AMD GPU (ROCm)
    # -------------------------------------------------------------------------
    # Requirements:
    #   - AMD GPU with ROCm support (RX 6000/7000, Radeon Instinct, Radeon Pro)
    #   - ROCm runtime installed: https://rocm.docs.amd.com/en/latest/deploy/linux/index.html
    #
    # Usage: Uncomment the lines below and comment out the NVIDIA deploy section above
    #
    # devices:
    #   - /dev/kfd              # AMD Kernel Fusion Driver
    #   - /dev/dri              # Direct Rendering Infrastructure
    # environment:
    #   - ROCM_PATH=/opt/rocm   # If using ROCm base image
    #
    # For full ROCm compute support, you may need to use a ROCm base image:
    # image: rocm/pytorch:rocm6.0_ubuntu22.04_py3.9_pytorch_2.0.1
    # (Then install SmarterRouter dependencies inside)

    # -------------------------------------------------------------------------
    # Intel Arc GPU
    # -------------------------------------------------------------------------
    # Requirements:
    #   - Intel Arc A-series GPU (A380, A770, etc.)
    #   - Intel GPU drivers (i915 kernel module)
    #   - Optional: Intel oneAPI Base Toolkit for compute
    #
    # Usage: Uncomment the lines below and comment out the NVIDIA deploy section above
    #
    # devices:
    #   - /dev/dri              # Direct Rendering Infrastructure
    # environment:
    #   - LEVEL_ZERO_DEVICE=0   # For oneAPI/Level Zero

    # -------------------------------------------------------------------------
    # Multi-GPU Setup (NVIDIA + AMD)
    # -------------------------------------------------------------------------
    # For systems with both NVIDIA and AMD GPUs:
    # 1. Uncomment BOTH the NVIDIA deploy section AND AMD devices
    # 2. SmarterRouter will detect and combine VRAM from all GPUs
    #
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    # devices:
    #   - /dev/kfd
    #   - /dev/dri

    # -------------------------------------------------------------------------
    # CPU-Only / No GPU
    # -------------------------------------------------------------------------
    # If you don't have a GPU or want to disable VRAM monitoring:
    # 1. Comment out ALL GPU sections above
    # 2. Add to your .env file: ROUTER_VRAM_MONITOR_ENABLED=false
    #
    # SmarterRouter will still work but without VRAM-based model management.

    # =========================================================================
    # END GPU CONFIGURATION
    # =========================================================================

networks:
  smarterrouter-network:
    driver: bridge

# =========================================================================
# OPTIONAL: Additional Services
# =========================================================================

# Redis for distributed rate limiting (uncomment if needed)
# redis:
#   image: redis:7-alpine
#   container_name: smarterrouter-redis
#   ports:
#     - "6379:6379"
#   volumes:
#     - redis-data:/data
#   restart: unless-stopped
#
# volumes:
#   redis-data:

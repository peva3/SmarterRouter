# SmarterRouter Docker Compose Configuration
# 
# GPU SUPPORT: Uncomment the section that matches your GPU setup below.
# SmarterRouter auto-detects GPUs on startup and logs what was found.
#
# QUICK START:
#   - NVIDIA: docker-compose --compatibility up -d
#   - AMD:    Comment out deploy section, uncomment devices section, then docker-compose up -d
#   - Intel:  Comment out deploy section, uncomment devices section, then docker-compose up -d
#
# IMPORTANT: The `deploy` section is ONLY for NVIDIA. AMD/Intel use `devices` at service level.
# See docs/docker-compose.amd.yml, docs/docker-compose.intel.yml for ready-to-use templates.

services:
  smarterrouter:
    image: ghcr.io/peva3/smarterrouter:latest
    container_name: smarterrouter
    ports:
      - "11436:11436"
    env_file:
      - .env
    volumes:
      # Mount a data directory for persistence (safer than mounting individual files)
      - ./data:/app/data:rw
      # Optional: mount tmpfs for temporary files if needed
      - type: tmpfs
        target: /tmp
    restart: unless-stopped
    networks:
      - smarterrouter-network
    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:11436/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # =========================================================================
    # GPU CONFIGURATION - Choose ONE section below
    # =========================================================================

    # -------------------------------------------------------------------------
    # NVIDIA GPU (Default - Full Docker Support)
    # -------------------------------------------------------------------------
    # Requirements:
    #   - NVIDIA drivers installed on host
    #   - NVIDIA Container Toolkit: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html
    #
    # Usage:
    #   docker-compose --compatibility up -d
    #   OR (newer Docker Compose): docker compose up -d --gpus all
    #
    # NOTE: For AMD or Intel GPUs, COMMENT OUT this entire deploy section!
    #
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # -------------------------------------------------------------------------
    # AMD GPU (ROCm) - COMMENT OUT NVIDIA deploy section above first!
    # -------------------------------------------------------------------------
    # Requirements:
    #   - AMD GPU with ROCm support (RX 6000/7000, Radeon Instinct, Radeon Pro)
    #   - ROCm runtime installed: https://rocm.docs.amd.com/en/latest/deploy/linux/index.html
    #
    # IMPORTANT: Comment out the entire 'deploy' section above before uncommenting!
    # The 'devices' section below goes at SERVICE level, NOT inside deploy.
    #
    # devices:
    #   - /dev/kfd              # AMD Kernel Fusion Driver
    #   - /dev/dri              # Direct Rendering Infrastructure
    # environment:
    #   - ROCM_PATH=/opt/rocm   # Optional: if using ROCm base image

    # -------------------------------------------------------------------------
    # Intel Arc GPU - COMMENT OUT NVIDIA deploy section above first!
    # -------------------------------------------------------------------------
    # Requirements:
    #   - Intel Arc A-series GPU (A380, A770, etc.)
    #   - Intel GPU drivers (i915 kernel module)
    #
    # IMPORTANT: Comment out the entire 'deploy' section above before uncommenting!
    #
    # devices:
    #   - /dev/dri              # Direct Rendering Infrastructure
    # environment:
    #   - LEVEL_ZERO_DEVICE=0   # Optional: For oneAPI/Level Zero

    # -------------------------------------------------------------------------
    # Multi-GPU (NVIDIA + AMD) - Keep deploy AND add devices
    # -------------------------------------------------------------------------
    # For systems with both NVIDIA and AMD GPUs, keep the deploy section
    # AND uncomment the devices section below:
    #
    # devices:
    #   - /dev/kfd
    #   - /dev/dri

    # -------------------------------------------------------------------------
    # CPU-Only / No GPU
    # -------------------------------------------------------------------------
    # Comment out ALL GPU sections above and add to your .env:
    # ROUTER_VRAM_MONITOR_ENABLED=false

    # =========================================================================
    # END GPU CONFIGURATION
    # =========================================================================

networks:
  smarterrouter-network:
    driver: bridge

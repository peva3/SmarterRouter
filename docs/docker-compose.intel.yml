# Docker Compose for Intel Arc GPUs
#
# Requirements:
#   - Intel Arc A-series GPU (A380, A750, A770, etc.)
#   - Intel Data Center GPU (Flex, Max series)
#   - Intel GPU drivers (i915 kernel module) - kernel 5.19+ recommended
#   - Verify: ls /sys/class/drm/card*/device/lmem_total should show local memory
#
# Note: Only dedicated Intel GPUs with local memory (lmem) are supported.
#       Integrated Intel UHD/Iris GPUs use shared system memory and are NOT supported.
#
# Quick Start:
#   1. Copy this file to your project root: cp docs/docker-compose.intel.yml docker-compose.yml
#   2. Copy environment template: cp ENV_DEFAULT .env
#   3. Run: docker-compose up -d
#
# Verify GPU access:
#   docker exec smarterrouter ls /sys/class/drm
#   docker logs smarterrouter | grep -i "intel\|gpu"
#
# Troubleshooting:
#   - Check Intel vendor ID: cat /sys/class/drm/card*/device/vendor (should be 0x8086)
#   - Check for dedicated memory: cat /sys/class/drm/card*/device/lmem_total
#   - Ensure i915 driver loaded: lsmod | grep i915
#
# For compute workloads (oneAPI/Level Zero):
#   You may need additional setup for Intel oneAPI:
#   - Install Intel oneAPI Base Toolkit on host
#   - Mount /opt/intel into container
#   - Set LEVEL_ZERO_DEVICE environment variable

services:
  smarterrouter:
    image: ghcr.io/peva3/smarterrouter:latest
    container_name: smarterrouter
    ports:
      - "11436:11436"
    env_file:
      - .env
    volumes:
      - ./data:/app/data:rw
      - type: tmpfs
        target: /tmp
    restart: unless-stopped
    networks:
      - smarterrouter-network
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:11436/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Intel GPU device passthrough
    devices:
      - /dev/dri                  # Direct Rendering Infrastructure
    
    # Optional: Intel oneAPI environment (for compute)
    # environment:
    #   - LEVEL_ZERO_DEVICE=0      # Select specific GPU
    #   - ZES_ENABLE_SYSMAN=1      # Enable system management
    #   - ROUTER_VRAM_MAX_TOTAL_GB=8

networks:
  smarterrouter-network:
    driver: bridge
